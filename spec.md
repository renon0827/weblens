# weblens - ä»•æ§˜æ›¸

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### 1.1 ç›®çš„
Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç”»é¢è¦ç´ ã‚’è¦–è¦šçš„ã«é¸æŠã—ã€Claude Code CLIã‚’é€šã˜ã¦AIã«æ”¹ä¿®ä¾é ¼ã‚’é€ä¿¡ã§ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

### 1.2 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ
- **Chromeæ‹¡å¼µæ©Ÿèƒ½**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨è¦ç´ é¸æŠæ©Ÿèƒ½ã‚’æä¾›
- **Webã‚µãƒ¼ãƒãƒ¼**: æ‹¡å¼µæ©Ÿèƒ½ã¨Claude Code CLIé–“ã®ä¸­ç¶™ã‚’æ‹…å½“

### 1.3 ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
1. é–‹ç™ºè€…ãŒãƒ­ãƒ¼ã‚«ãƒ«ã§Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºä¸­
2. ç”»é¢ä¸Šã®ç‰¹å®šè¦ç´ ã‚’é¸æŠã—ã€Œã“ã®ãƒœã‚¿ãƒ³ã®è‰²ã‚’é’ã«å¤‰æ›´ã—ã¦ã€ç­‰ã®ä¾é ¼
3. AIãŒè©²å½“ã‚³ãƒ¼ãƒ‰ã‚’ç‰¹å®šã—ã€è‡ªå‹•ã§ä¿®æ­£ã‚’å®Ÿæ–½

---

## 2. æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### 2.1 å…±é€š
| é …ç›® | æŠ€è¡“ |
|------|------|
| è¨€èª | TypeScript 5.x |
| ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ« | Vite 5.x |
| ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç† | npm workspaces (ãƒ¢ãƒãƒ¬ãƒ) |
| ã‚³ãƒ¼ãƒ‰å“è³ª | ESLint + Prettier |

### 2.2 Chromeæ‹¡å¼µæ©Ÿèƒ½
| é …ç›® | æŠ€è¡“ |
|------|------|
| ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ | Manifest V3 |
| UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Preact 10.x |
| ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° | CSS Modules |
| çŠ¶æ…‹ç®¡ç† | Preact Signals |

### 2.3 Webã‚µãƒ¼ãƒãƒ¼
| é …ç›® | æŠ€è¡“ |
|------|------|
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  | Node.js 20.x LTS |
| HTTPã‚µãƒ¼ãƒãƒ¼ | Fastify 4.x |
| WebSocket | ws 8.x |
| ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ | Node.js child_process (spawn) |

---

## 3. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
weblens/
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ specification.md        # æœ¬ä»•æ§˜æ›¸
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ extension/              # Chromeæ‹¡å¼µæ©Ÿèƒ½
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ background/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts          # Service Worker
â”‚   â”‚   â”‚   â”œâ”€â”€ content/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts          # Content Script ã‚¨ãƒ³ãƒˆãƒª
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ElementSelector.ts # è¦ç´ é¸æŠãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Highlighter.ts     # ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ styles.css         # æ³¨å…¥ç”¨ã‚¹ã‚¿ã‚¤ãƒ«
â”‚   â”‚   â”‚   â”œâ”€â”€ sidepanel/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.html        # Side Panel HTML
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ main.tsx          # Preact ã‚¨ãƒ³ãƒˆãƒª
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ App.tsx           # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ConversationList.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ChatView.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MessageInput.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ElementList.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ElementCard.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useWebSocket.ts
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useConversation.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ global.css
â”‚   â”‚   â”‚   â”œâ”€â”€ shared/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts          # å…±é€šå‹å®šç¾©
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ messages.ts       # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°å®šç¾©
â”‚   â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚   â”‚       â””â”€â”€ elementInfo.ts    # è¦ç´ æƒ…å ±æŠ½å‡º
â”‚   â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â”‚   â””â”€â”€ icons/                # æ‹¡å¼µæ©Ÿèƒ½ã‚¢ã‚¤ã‚³ãƒ³
â”‚   â”‚   â”œâ”€â”€ manifest.json
â”‚   â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ server/                 # Webã‚µãƒ¼ãƒãƒ¼
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ index.ts              # ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ³ãƒˆãƒª
â”‚       â”‚   â”œâ”€â”€ api/
â”‚       â”‚   â”‚   â”œâ”€â”€ routes.ts         # REST APIãƒ«ãƒ¼ãƒˆ
â”‚       â”‚   â”‚   â”œâ”€â”€ conversations.ts  # ä¼šè©±API
â”‚       â”‚   â”‚   â””â”€â”€ health.ts         # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
â”‚       â”‚   â”œâ”€â”€ ws/
â”‚       â”‚   â”‚   â”œâ”€â”€ handler.ts        # WebSocketãƒãƒ³ãƒ‰ãƒ©
â”‚       â”‚   â”‚   â””â”€â”€ connections.ts    # æ¥ç¶šç®¡ç†
â”‚       â”‚   â”œâ”€â”€ claude/
â”‚       â”‚   â”‚   â”œâ”€â”€ executor.ts       # claude -p å®Ÿè¡Œ
â”‚       â”‚   â”‚   â”œâ”€â”€ sessionManager.ts # ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç®¡ç†
â”‚       â”‚   â”‚   â””â”€â”€ promptBuilder.ts  # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆçµ„ã¿ç«‹ã¦
â”‚       â”‚   â”œâ”€â”€ storage/
â”‚       â”‚   â”‚   â”œâ”€â”€ fileStore.ts      # JSONãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
â”‚       â”‚   â”‚   â””â”€â”€ types.ts          # ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å‹å®šç¾©
â”‚       â”‚   â””â”€â”€ utils/
â”‚       â”‚       â””â”€â”€ logger.ts         # ãƒ­ã‚®ãƒ³ã‚°
â”‚       â”œâ”€â”€ data/                     # æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿
â”‚       â”‚   â””â”€â”€ conversations/        # ä¼šè©±JSONãƒ•ã‚¡ã‚¤ãƒ«
â”‚       â”œâ”€â”€ vite.config.ts
â”‚       â”œâ”€â”€ tsconfig.json
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ package.json                # ãƒ«ãƒ¼ãƒˆpackage.json
â”œâ”€â”€ tsconfig.base.json          # å…±é€šTypeScriptè¨­å®š
â”œâ”€â”€ .eslintrc.js
â”œâ”€â”€ .prettierrc
â””â”€â”€ README.md
```

---

## 4. Chromeæ‹¡å¼µæ©Ÿèƒ½ä»•æ§˜

### 4.1 ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ (manifest.json)

```json
{
  "manifest_version": 3,
  "name": "weblens",
  "version": "1.0.0",
  "description": "Webè¦ç´ ã‚’é¸æŠã—ã¦Claude Codeã«æ”¹ä¿®ä¾é ¼ã‚’é€ä¿¡",
  "permissions": [
    "activeTab",
    "sidePanel",
    "contextMenus",
    "storage"
  ],
  "host_permissions": [
    "<all_urls>"
  ],
  "background": {
    "service_worker": "background/index.js",
    "type": "module"
  },
  "content_scripts": [
    {
      "matches": ["<all_urls>"],
      "js": ["content/index.js"],
      "css": ["content/styles.css"],
      "run_at": "document_idle"
    }
  ],
  "side_panel": {
    "default_path": "sidepanel/index.html"
  },
  "icons": {
    "16": "icons/icon16.png",
    "48": "icons/icon48.png",
    "128": "icons/icon128.png"
  }
}
```

### 4.2 Background Script (Service Worker)

#### æ©Ÿèƒ½
1. å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œweblensã§é–‹ãã€ã‚’ç™»éŒ²
2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã«Side Panelã‚’é–‹ã
3. Content Scriptã¨Side Panelé–“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ç¶™

#### ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼
```typescript
chrome.contextMenus.create({
  id: "open-weblens",
  title: "weblensã§é–‹ã",
  contexts: ["page", "selection", "image", "link"]
});
```

### 4.3 Content Script

#### 4.3.1 è¦ç´ é¸æŠãƒ¢ãƒ¼ãƒ‰

**é–‹å§‹ãƒˆãƒªã‚¬ãƒ¼**: Side Panelã‹ã‚‰ã€Œè¦ç´ é¸æŠã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡

**å‹•ä½œ**:
1. ãƒšãƒ¼ã‚¸å…¨ä½“ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é…ç½®ï¼ˆpointer-events: noneï¼‰
2. ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼æ™‚ã«è¦ç´ ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
3. ã‚¯ãƒªãƒƒã‚¯ã§è¦ç´ ã‚’é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰
4. Escã‚­ãƒ¼ã§é¸æŠãƒ¢ãƒ¼ãƒ‰çµ‚äº†

#### 4.3.2 ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºä»•æ§˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ div.button-container                â”‚ â† ãƒ©ãƒ™ãƒ«ï¼ˆã‚¿ã‚°å.ã‚¯ãƒ©ã‚¹åï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚         [è¦ç´ ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„]            â”‚ â† è¦ç´ æœ¬ä½“
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘ é’è‰²ãƒœãƒ¼ãƒ€ãƒ¼ (2px solid #3b82f6)
```

**ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚¹ã‚¿ã‚¤ãƒ«**:
- ãƒœãƒ¼ãƒ€ãƒ¼: 2px solid #3b82f6 (é’)
- èƒŒæ™¯: rgba(59, 130, 246, 0.1)
- ãƒ©ãƒ™ãƒ«èƒŒæ™¯: #3b82f6
- ãƒ©ãƒ™ãƒ«æ–‡å­—: #ffffff, 12px, monospace

**é¸æŠæ¸ˆã¿è¦ç´ ã‚¹ã‚¿ã‚¤ãƒ«**:
- ãƒœãƒ¼ãƒ€ãƒ¼: 2px solid #22c55e (ç·‘)
- èƒŒæ™¯: rgba(34, 197, 94, 0.1)
- ãƒ©ãƒ™ãƒ«èƒŒæ™¯: #22c55e

#### 4.3.3 è¦ç´ æƒ…å ±æŠ½å‡º

é¸æŠã—ãŸè¦ç´ ã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡ºï¼š

```typescript
interface ElementInfo {
  // è­˜åˆ¥æƒ…å ±
  id: string;                    // ä¸€æ„ã®ID (UUID)
  tagName: string;               // ã‚¿ã‚°å (å°æ–‡å­—)

  // ã‚»ãƒ¬ã‚¯ã‚¿
  selector: string;              // ä¸€æ„ãªCSSã‚»ãƒ¬ã‚¯ã‚¿
  xpath: string;                 // XPath

  // å±æ€§
  id_attr: string | null;        // idå±æ€§
  className: string;             // classå±æ€§
  attributes: Record<string, string>; // ãã®ä»–ã®å±æ€§

  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
  textContent: string;           // ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆãƒˆãƒªãƒ æ¸ˆã¿ã€500æ–‡å­—ã¾ã§ï¼‰
  innerText: string;             // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒˆãƒªãƒ æ¸ˆã¿ã€500æ–‡å­—ã¾ã§ï¼‰
  innerHTML: string;             // å†…éƒ¨HTMLï¼ˆ5000æ–‡å­—ã¾ã§ï¼‰
  outerHTML: string;             // å¤–éƒ¨HTMLï¼ˆ10000æ–‡å­—ã¾ã§ï¼‰

  // ã‚¹ã‚¿ã‚¤ãƒ«
  computedStyles: {
    display: string;
    position: string;
    width: string;
    height: string;
    color: string;
    backgroundColor: string;
    fontSize: string;
    fontFamily: string;
    margin: string;
    padding: string;
    border: string;
    // ä»–ã€ä¸»è¦ãªCSSãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
  };

  // ä½ç½®æƒ…å ±
  boundingRect: {
    top: number;
    left: number;
    width: number;
    height: number;
  };

  // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
  parentInfo: {
    tagName: string;
    id_attr: string | null;
    className: string;
  };

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
  comment: string;               // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»˜ã‘ãŸã‚³ãƒ¡ãƒ³ãƒˆ
}
```

### 4.4 Side Panel

#### 4.4.1 ç”»é¢æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  weblens                    [è¨­å®š]  â”‚ â† ãƒ˜ãƒƒãƒ€ãƒ¼
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¼šè©±ä¸€è¦§                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ“ ä¼šè©± #1 - 2024/01/15        â”‚â”‚ â† ä¼šè©±ãƒªã‚¹ãƒˆ
â”‚  â”‚ ğŸ“ ä¼šè©± #2 - 2024/01/14        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  [+ æ–°è¦ä¼šè©±]                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ãƒãƒ£ãƒƒãƒˆå±¥æ­´                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ‘¤ ãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰æ›´ã—ã¦          â”‚â”‚ â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
â”‚  â”‚   ğŸ“ button.submit              â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ ğŸ¤– ãƒœã‚¿ãƒ³ã®è‰²ã‚’é’ã«å¤‰æ›´ã—ã¾ã—ãŸ   â”‚â”‚ â† AIå¿œç­”
â”‚  â”‚   å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«: src/Button.tsx  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é¸æŠä¸­ã®è¦ç´                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ button.submit-btn               â”‚â”‚
â”‚  â”‚ ã‚³ãƒ¡ãƒ³ãƒˆ: [ã“ã®è‰²ã‚’å¤‰æ›´]         â”‚â”‚ â† è¦ç´ ã‚«ãƒ¼ãƒ‰
â”‚  â”‚ [Ã— å‰Šé™¤]                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  [ğŸ¯ è¦ç´ ã‚’é¸æŠ]                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...]        [é€ä¿¡] â”‚ â† å…¥åŠ›ã‚¨ãƒªã‚¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.4.2 çŠ¶æ…‹ç®¡ç†

```typescript
interface AppState {
  // æ¥ç¶šçŠ¶æ…‹
  connectionStatus: 'connecting' | 'connected' | 'disconnected' | 'error';

  // ä¼šè©±
  conversations: Conversation[];
  activeConversationId: string | null;

  // ç¾åœ¨ã®ä¼šè©±
  messages: Message[];
  selectedElements: ElementInfo[];

  // UIçŠ¶æ…‹
  isSelectingElement: boolean;
  isSending: boolean;
}

interface Conversation {
  id: string;                    // UUID
  sessionId: string | null;      // Claude Codeã‚»ãƒƒã‚·ãƒ§ãƒ³ IDï¼ˆåˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾Œã«è¨­å®šï¼‰
  title: string;                 // ä¼šè©±ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰è‡ªå‹•ç”Ÿæˆï¼‰
  createdAt: string;             // ISO 8601
  updatedAt: string;             // ISO 8601
}

interface Message {
  id: string;                    // UUID
  role: 'user' | 'assistant';
  content: string;
  elements?: ElementInfo[];      // æ·»ä»˜ã•ã‚ŒãŸè¦ç´ æƒ…å ±
  timestamp: string;             // ISO 8601
}
```

---

## 5. Webã‚µãƒ¼ãƒãƒ¼ä»•æ§˜

### 5.1 ã‚µãƒ¼ãƒãƒ¼è¨­å®š

| é …ç›® | å€¤ |
|------|-----|
| ãƒ›ã‚¹ãƒˆ | localhost |
| HTTPãƒãƒ¼ãƒˆ | 3456 |
| WebSocketãƒ‘ã‚¹ | /ws |
| CORS | localhostè¨±å¯ |

### 5.2 REST API

#### 5.2.1 ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

```
GET /api/health

Response:
{
  "status": "ok",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

#### 5.2.2 ä¼šè©±ä¸€è¦§å–å¾—

```
GET /api/conversations

Response:
{
  "conversations": [
    {
      "id": "uuid-1",
      "sessionId": "claude-session-1",
      "title": "ãƒœã‚¿ãƒ³ã®è‰²å¤‰æ›´",
      "createdAt": "2024-01-15T10:00:00Z",
      "updatedAt": "2024-01-15T10:30:00Z"
    }
  ]
}
```

#### 5.2.3 ä¼šè©±ä½œæˆ

```
POST /api/conversations

Response:
{
  "id": "uuid-new",
  "sessionId": null,           // æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¾Œã«Claude Codeã‹ã‚‰å–å¾—
  "title": "æ–°è¦ä¼šè©±",
  "createdAt": "2024-01-15T11:00:00Z",
  "updatedAt": "2024-01-15T11:00:00Z"
}
```

**æ³¨æ„**: `sessionId`ã¯æœ€åˆã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã«Claude Codeã‹ã‚‰ç™ºè¡Œã•ã‚Œã€è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã‚‹ã€‚

#### 5.2.4 ä¼šè©±è©³ç´°å–å¾—

```
GET /api/conversations/:id

Response:
{
  "id": "uuid-1",
  "sessionId": "claude-session-1",
  "title": "ãƒœã‚¿ãƒ³ã®è‰²å¤‰æ›´",
  "createdAt": "2024-01-15T10:00:00Z",
  "updatedAt": "2024-01-15T10:30:00Z",
  "messages": [
    {
      "id": "msg-1",
      "role": "user",
      "content": "ã“ã®ãƒœã‚¿ãƒ³ã®è‰²ã‚’é’ã«å¤‰æ›´ã—ã¦",
      "elements": [...],
      "timestamp": "2024-01-15T10:00:00Z"
    },
    {
      "id": "msg-2",
      "role": "assistant",
      "content": "ãƒœã‚¿ãƒ³ã®è‰²ã‚’é’ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚",
      "timestamp": "2024-01-15T10:00:30Z"
    }
  ]
}
```

#### 5.2.5 ä¼šè©±å‰Šé™¤

```
DELETE /api/conversations/:id

Response:
{
  "success": true
}
```

### 5.3 WebSocketä»•æ§˜

#### 5.3.1 æ¥ç¶š

```
ws://localhost:3456/ws
```

#### 5.3.2 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼**:

```typescript
// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
{
  "type": "chat",
  "payload": {
    "conversationId": "uuid-1",
    "message": "ã“ã®ãƒœã‚¿ãƒ³ã®è‰²ã‚’é’ã«å¤‰æ›´ã—ã¦",
    "elements": [
      {
        "id": "elem-1",
        "tagName": "button",
        "selector": "button.submit-btn",
        "comment": "ã“ã®è‰²ã‚’å¤‰æ›´",
        // ... ãã®ä»–ã®ElementInfo
      }
    ]
  }
}

// å‡¦ç†ä¸­æ–­
{
  "type": "abort",
  "payload": {
    "conversationId": "uuid-1"
  }
}
```

**ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**:

```typescript
// æ¥ç¶šç¢ºç«‹
{
  "type": "connected",
  "payload": {
    "connectionId": "conn-uuid"
  }
}

// ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¿œç­”ï¼ˆãƒãƒ£ãƒ³ã‚¯ï¼‰
{
  "type": "chunk",
  "payload": {
    "conversationId": "uuid-1",
    "content": "ãƒœã‚¿ãƒ³ã®è‰²ã‚’",
    "messageId": "msg-uuid"
  }
}

// å¿œç­”å®Œäº†
{
  "type": "complete",
  "payload": {
    "conversationId": "uuid-1",
    "messageId": "msg-uuid",
    "fullContent": "ãƒœã‚¿ãƒ³ã®è‰²ã‚’é’ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚å¤‰æ›´ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«: src/Button.tsx"
  }
}

// ã‚¨ãƒ©ãƒ¼
{
  "type": "error",
  "payload": {
    "conversationId": "uuid-1",
    "error": "Claude Code ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ",
    "code": "CLAUDE_EXECUTION_ERROR"
  }
}
```

### 5.4 Claude Code é€£æº

#### 5.4.1 ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

**æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³**:
```bash
claude -p "<prompt>" --output-format stream-json
```

**æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶š**:
```bash
claude -p "<prompt>" --resume <session_id> --output-format stream-json
```

#### 5.4.2 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰

```typescript
function buildPrompt(message: string, elements: ElementInfo[]): string {
  let prompt = '';

  if (elements.length > 0) {
    prompt += '## å¯¾è±¡è¦ç´ \n\n';

    for (const elem of elements) {
      prompt += `### è¦ç´ : ${elem.tagName}${elem.id_attr ? `#${elem.id_attr}` : ''}${elem.className ? `.${elem.className.split(' ').join('.')}` : ''}\n\n`;
      prompt += `- ã‚»ãƒ¬ã‚¯ã‚¿: \`${elem.selector}\`\n`;
      prompt += `- XPath: \`${elem.xpath}\`\n`;

      if (elem.comment) {
        prompt += `- ã‚³ãƒ¡ãƒ³ãƒˆ: ${elem.comment}\n`;
      }

      prompt += `\n**HTMLæ§‹é€ :**\n\`\`\`html\n${elem.outerHTML}\n\`\`\`\n\n`;

      prompt += `**è¨ˆç®—æ¸ˆã¿ã‚¹ã‚¿ã‚¤ãƒ«:**\n\`\`\`json\n${JSON.stringify(elem.computedStyles, null, 2)}\n\`\`\`\n\n`;
    }
  }

  prompt += `## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ä¾é ¼\n\n${message}`;

  return prompt;
}
```

#### 5.4.3 ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç®¡ç†

**é‡è¦**: ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã¯Claude Code CLIãŒç™ºè¡Œã™ã‚‹ã‚‚ã®ã‚’ä½¿ç”¨ã™ã‚‹ã€‚è‡ªå‰ç™ºè¡Œã§ã¯`--resume`ãŒæ©Ÿèƒ½ã—ãªã„ã€‚

**æ–°è¦ä¼šè©±ã®æµã‚Œ**:
1. æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã€`--resume`ãªã—ã§`claude -p`ã‚’å®Ÿè¡Œ
2. Claude Codeã®å‡ºåŠ›ï¼ˆstream-jsonï¼‰ã‹ã‚‰`session_id`ã‚’å–å¾—
3. å–å¾—ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ä¼šè©±ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜

**æ—¢å­˜ä¼šè©±ã®ç¶™ç¶š**:
1. ä¿å­˜æ¸ˆã¿ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ä½¿ç”¨
2. `claude -p --resume <session_id>`ã§å®Ÿè¡Œ
3. ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒå¼•ãç¶™ãŒã‚Œã‚‹

**ã‚»ãƒƒã‚·ãƒ§ãƒ³IDå–å¾—ã‚¿ã‚¤ãƒŸãƒ³ã‚°**:
```typescript
// stream-jsonå‡ºåŠ›ã®ä¾‹
{"type":"system","subtype":"init","session_id":"abc123-def456-..."}
```

åˆå›å®Ÿè¡Œæ™‚ã®`init`ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰`session_id`ã‚’æŠ½å‡ºã—ã€ä¼šè©±ã«ç´ã¥ã‘ã¦ä¿å­˜ã™ã‚‹ã€‚

#### 5.4.4 ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡ºåŠ›è§£æ

`--output-format stream-json`ã®å‡ºåŠ›ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§WebSocketã«è»¢é€ï¼š

```typescript
interface ClaudeStreamMessage {
  type: 'assistant' | 'result' | 'system';
  subtype?: string;
  content?: string;
  session_id?: string;
}
```

### 5.5 ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–

#### 5.5.1 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
data/
â””â”€â”€ conversations/
    â”œâ”€â”€ {conversation-id-1}.json
    â”œâ”€â”€ {conversation-id-2}.json
    â””â”€â”€ ...
```

#### 5.5.2 ä¼šè©±ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼

```json
{
  "id": "uuid-1",
  "sessionId": "abc123-def456-...",  // Claude Codeç™ºè¡Œã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆåˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰ã¯nullï¼‰
  "title": "ãƒœã‚¿ãƒ³ã®è‰²å¤‰æ›´",
  "createdAt": "2024-01-15T10:00:00Z",
  "updatedAt": "2024-01-15T10:30:00Z",
  "messages": [
    {
      "id": "msg-1",
      "role": "user",
      "content": "ã“ã®ãƒœã‚¿ãƒ³ã®è‰²ã‚’é’ã«å¤‰æ›´ã—ã¦",
      "elements": [
        {
          "id": "elem-1",
          "tagName": "button",
          "selector": "button.submit-btn",
          "comment": "ã“ã®è‰²ã‚’å¤‰æ›´",
          "outerHTML": "<button class=\"submit-btn\">é€ä¿¡</button>",
          "computedStyles": { ... }
        }
      ],
      "timestamp": "2024-01-15T10:00:00Z"
    },
    {
      "id": "msg-2",
      "role": "assistant",
      "content": "ãƒœã‚¿ãƒ³ã®è‰²ã‚’é’ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚",
      "timestamp": "2024-01-15T10:00:30Z"
    }
  ]
}
```

---

## 6. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ä»•æ§˜

### 6.1 æ‹¡å¼µæ©Ÿèƒ½å†…éƒ¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

#### Background â†” Content Script

```typescript
// è¦ç´ é¸æŠãƒ¢ãƒ¼ãƒ‰é–‹å§‹
{
  type: 'START_ELEMENT_SELECTION'
}

// è¦ç´ é¸æŠãƒ¢ãƒ¼ãƒ‰çµ‚äº†
{
  type: 'STOP_ELEMENT_SELECTION'
}

// è¦ç´ ãŒé¸æŠã•ã‚ŒãŸ
{
  type: 'ELEMENT_SELECTED',
  payload: ElementInfo
}

// é¸æŠæ¸ˆã¿è¦ç´ ã‚’å‰Šé™¤
{
  type: 'REMOVE_SELECTED_ELEMENT',
  payload: { id: string }
}
```

#### Background â†” Side Panel

```typescript
// è¦ç´ é¸æŠçµæœã‚’é€šçŸ¥
{
  type: 'ELEMENTS_UPDATED',
  payload: ElementInfo[]
}

// WebSocketæ¥ç¶šçŠ¶æ…‹
{
  type: 'CONNECTION_STATUS',
  payload: { status: 'connected' | 'disconnected' | 'error' }
}
```

---

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 7.1 ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰

| ã‚³ãƒ¼ãƒ‰ | èª¬æ˜ |
|--------|------|
| `CONNECTION_FAILED` | WebSocketæ¥ç¶šå¤±æ•— |
| `CLAUDE_NOT_FOUND` | claudeã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚‰ãªã„ |
| `CLAUDE_EXECUTION_ERROR` | claudeå®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼ |
| `SESSION_NOT_FOUND` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„ |
| `INVALID_MESSAGE` | ä¸æ­£ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ |
| `STORAGE_ERROR` | ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼ |

### 7.2 ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥

- WebSocketæ¥ç¶š: æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆæœ€å¤§5å›ã€1ç§’â†’2ç§’â†’4ç§’â†’8ç§’â†’16ç§’ï¼‰
- Claudeå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ãƒªãƒˆãƒ©ã‚¤ãªã—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ï¼‰

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 8.1 åˆ¶é™äº‹é …
- localhostæ¥ç¶šã®ã¿è¨±å¯
- èªè¨¼ã¯å®Ÿè£…ã—ãªã„ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨é€”ã®ãŸã‚ï¼‰
- å¤–éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯

### 8.2 ãƒ‡ãƒ¼ã‚¿ä¿è­·
- è¦ç´ æƒ…å ±ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã«ã®ã¿ä¿å­˜
- å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®é€ä¿¡ã¯Claude Code CLIçµŒç”±ã®ã¿

---

## 9. é–‹ç™ºãƒ»ãƒ“ãƒ«ãƒ‰æ‰‹é †

### 9.1 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone <repository>
cd weblens

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆã‚µãƒ¼ãƒãƒ¼ï¼‰
npm run dev:server

# é–‹ç™ºãƒ“ãƒ«ãƒ‰ï¼ˆæ‹¡å¼µæ©Ÿèƒ½ï¼‰
npm run dev:extension
```

### 9.2 æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

1. Chrome ã§ `chrome://extensions` ã‚’é–‹ã
2. ã€Œãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã€ã‚’æœ‰åŠ¹åŒ–
3. ã€Œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚Œã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. `packages/extension/dist` ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ

### 9.3 æœ¬ç•ªãƒ“ãƒ«ãƒ‰

```bash
# å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
npm run build

# æ‹¡å¼µæ©Ÿèƒ½ã®ã¿
npm run build:extension

# ã‚µãƒ¼ãƒãƒ¼ã®ã¿
npm run build:server
```

---

## 10. ä»Šå¾Œã®æ‹¡å¼µæ¡ˆï¼ˆã‚¹ã‚³ãƒ¼ãƒ—å¤–ï¼‰

ä»¥ä¸‹ã¯åˆæœŸãƒªãƒªãƒ¼ã‚¹ã«ã¯å«ã‚ãªã„ãŒã€å°†æ¥çš„ã«æ¤œè¨ï¼š

1. **ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ·»ä»˜**: é¸æŠè¦ç´ ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’AIã«é€ä¿¡
2. **è¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¯¾å¿œ**: ç•°ãªã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆ
3. **ãƒãƒ¼ãƒ å…±æœ‰æ©Ÿèƒ½**: ä¼šè©±å±¥æ­´ã‚’ãƒãƒ¼ãƒ ã§å…±æœ‰
4. **Firefoxå¯¾å¿œ**: WebExtensions APIã§ã®ã‚¯ãƒ­ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ
5. **è‡ªå‹•ææ¡ˆ**: ãƒ›ãƒãƒ¼ä¸­ã®è¦ç´ ã«å¯¾ã™ã‚‹æ”¹å–„ææ¡ˆã‚’è‡ªå‹•è¡¨ç¤º
